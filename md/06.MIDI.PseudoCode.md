
## MIDI & Pseudocode

Note: 

---H
### What is MIDI?

---V
 
<h3>
<span class="fragment highlight-current-blue" data-fragment-index="1"><b class="fragment highlight-blue" data-fragment-index="5">M</b><span class="fragment fade-in" data-fragment-index="1">usical </span></span>
<span class="fragment highlight-current-blue" data-fragment-index="2"><b class="fragment highlight-blue" data-fragment-index="5">I</b><span class="fragment fade-in" data-fragment-index="2">nstrument </span></span>
<span class="fragment highlight-current-blue" data-fragment-index="3"><b class="fragment highlight-blue" data-fragment-index="5">D</b><span class="fragment fade-in" data-fragment-index="3">igital </span></span>
<span class="fragment highlight-current-blue" data-fragment-index="4"><b class="fragment highlight-blue" data-fragment-index="5">I</b><span class="fragment fade-in" data-fragment-index="4">nterface </span></span>
</h3>

---

<p class="fragment fade-in" data-fragment-index="6"><em>used to specify or control the actions of a device</em></p>
<p class="fragment fade-in" data-fragment-index="7"><em> the tone or effect is generated by the device itself</em></p>
<p class="fragment fade-in" data-fragment-index="8"><em>MIDI does not produce sound</em></p>
<div class="fragment fade-in" data-fragment-index="6"style="text-align: left; font-size: small">Jeffrey Hass, <em>Introduction to Computer Music</em>, <a href="https://cmtext.com/MIDI/chapter3_MIDI.php" target="_blank">https://cmtext.com/MIDI/chapter3_MIDI.php</a></div>

---V

### MIDI Data Format

<p style="text-align: left" class="fragment fade-in" data-fragment-index="1">A MIDI Message<sup>1</sup> is a three-byte package of data.</p>

<p style="text-align: left" class="fragment fade-in" data-fragment-index="2"><u>1 bit</u>: a <code>0</code> or <code>0</code> has two possible values</p>
<p style="text-align: left" class="fragment fade-in" data-fragment-index="3"><u>1 byte</u>: is 8 bits <code>00000000</code>, <code>00000001</code>, <code>00000010</code> &hellip;</p>
<p style="text-align: right" class="fragment fade-in" data-fragment-index="4"><em class="fragment highlight-current-blue" data-fragment-index="4">So, how many values can 1 byte express?</em></p>
<p class="fragment fade-in" data-fragment-index="5"><span class="fragment highlight-current-red" data-fragment-index="5">256</span></p>

<div class="fragment fade-in" data-fragment-index="1" style="text-align: left; font-size: small"><sup>1</sup>We are going to focus on MIDI Channel Voice Messages only</div>
Note: Arrays are the simplest way to store multiple values like MIDI notes or frequencies.

---V

### The Byte

<table>
  <tr>
    <td colspan="2" style="text-align: center" class="fragment fade-in">The Byte</td>
  </tr>
<tr>
    <td colspan="2" style="text-align: center" class="fragment fade-in"><code>10011101</code></td>
  </tr>
  <tr >
    <td style="text-align: center" class="fragment fade-in"><code>1101</code></td>
    <td style="text-align: center" class="fragment fade-in"><code>1101</code></td>
  </tr>
<tr>
    <td style="text-align: center" class="fragment fade-in">High Nibble</td>
    <td style="text-align: center" class="fragment fade-in">Low Nibble</td>
  </tr>
</table>

---V

### MIDI Data Format



$$ \text{Time per byte } \approx 320 \ \mu s \approx \frac{3077\ \text {bytes}}{\text{sec}} $$

<div style="font-size: smaller">Status&hellip;Data&hellip;Data&hellip;Status&hellip;Data&hellip;Data&hellip;Status&hellip;Data&hellip;Data&hellip;</div>
---V

### Keeping Track

To differentiate between the two kinds of bytes, the MIDI protocol specifies that:
- Status Bytes start with `1`
- Data bytes start with `0`


---V

### MIDI Data Format

| Status Byte | Data Byte 1 |Data Byte 2 |
|-------------|-------------|------------|
| `1???????`  | `0???????`  | `0???????` |

<p style="text-align: left" class="fragment fade-in" data-fragment-index="1">This leaves 7 bits to express MIDI data in each byte</p>
<p style="text-align: right" class="fragment fade-in" data-fragment-index="2"><em class="fragment highlight-current-blue" data-fragment-index="2">So, how many values can 7 bits express?</em></p>
<p class="fragment fade-in" data-fragment-index="3"><span class="fragment highlight-current-red" data-fragment-index="3">128</span></p>
<p class="fragment fade-in" data-fragment-index="4"><span class="fragment highlight-current-green" data-fragment-index="4">0-127</span></p>

---V

### The Status Byte
The Status Byte tell us two things with its 7 bits:

<table>
    <tr>
        <th class="fragment fade-in" data-fragment-index="1" style="text-align: center">Message Type (4 bits)</th>
        <th class="fragment fade-in" data-fragment-index="3">Channel Number (4 bits)</th>
    </tr>
    <tr>
        <td class="fragment fade-in" data-fragment-index="1" style="text-align: center"><em>High Nibble</em></td>
        <td class="fragment fade-in" data-fragment-index="3" style="text-align: center"><em>Low Nibble</em></td>
    </tr>
    <tr>
        <td class="fragment fade-in" data-fragment-index="2" style="font-size: smaller">
            <ol >
                    <li>Note Off <code class="fragment fade-in" data-fragment-index="6">1000cccc</code></li>
                    <li>Note On <code class="fragment fade-in" data-fragment-index="6">1001cccc</code></li>
                    <li>Poly Key Pressure <code class="fragment fade-in" data-fragment-index="6">1010cccc</code></li>
                    <li>Controller Change <code class="fragment fade-in" data-fragment-index="6">1011cccc</code></li>
                    <li>Program Change <code class="fragment fade-in" data-fragment-index="6">1100cccc</code></li>
                    <li>Channel Pressure <code class="fragment fade-in" data-fragment-index="6">1101cccc</code></li>
                    <li>Pitch Bend <code class="fragment fade-in" data-fragment-index="6">1110cccc</code></li>
            </ol>
        </td>
        <td class="fragment fade-in" data-fragment-index="4" style="font-size: smaller; vertical-align: top; text-align: center">
            16 MIDI Channels<br><br>
            <span style="font-size: xxx-large" class="fragment fade-in" data-fragment-index="5"><code>1mmmcccc</code></span>
            <table  class="fragment fade-in" data-fragment-index="7">
              <tr>
                <td><code>0000</code></td>
                <td><code>0001</code></td>
                <td><code>0010</code></td>
                <td><code>0011</code></td>
              </tr>
              <tr>
                <td><code>0100</code></td>
                <td><code>0101</code></td>
                <td><code>0110</code></td>
                <td><code>0111</code></td>
              </tr>
              <tr>
                <td><code>1000</code></td>
                <td><code>1001</code></td>
                <td><code>1010</code></td>
                <td><code>1011</code></td>
              </tr>
              <tr>
                <td><code>1100</code></td>
                <td><code>1101</code></td>
                <td><code>1110</code></td>
                <td><code>1111</code></td>
              </tr>
            </table>
        </td>
    </tr>
    
</table>

---V 

### The Data Bytes
2 Data Bytes follow each Status Byte:

<table style="font-size: smaller">
<tr>
        <td></td>
        <td class="fragment fade-in" data-fragment-index="3" style="text-align: center"><code>0xxxxxxx</code></td>
        <td class="fragment fade-in" data-fragment-index="3" style="text-align: center"><code>0xxxxxxx</code></td>
    </tr>    
<tr>
        <th class="fragment fade-in" data-fragment-index="4">Status Byte</th>
        <th class="fragment fade-in" data-fragment-index="1" style="text-align: center">Data Byte 1</th>
        <th class="fragment fade-in" data-fragment-index="2">Data Byte 2</th>
    </tr>
    <tr class="fragment highlight-current-blue" data-fragment-index="6" >
        <th class="fragment fade-in" data-fragment-index="5" style="font-size: smaller">
            Note Off
        </th>
        <td class="fragment fade-in" data-fragment-index="6" style="font-size: smaller; vertical-align: top; text-align: center">Key (0-127)</td>
        <td class="fragment fade-in" data-fragment-index="6" style="font-size: smaller; vertical-align: top; text-align: center">Velocity (0-127)</td>
    </tr>
<tr class="fragment highlight-current-blue" data-fragment-index="7" >
        <th class="fragment fade-in" data-fragment-index="5" style="font-size: smaller">
            Note On
        </th>
        <td class="fragment fade-in" data-fragment-index="7" style="font-size: smaller; vertical-align: top; text-align: center">Key (0-127)</td>
        <td class="fragment fade-in" data-fragment-index="7" style="font-size: smaller; vertical-align: top; text-align: center">Velocity (0-127)</td>
    </tr>
<tr class="fragment highlight-current-blue" data-fragment-index="8" >
        <th class="fragment fade-in" data-fragment-index="5" style="font-size: smaller">
            Poly Key Pressure
        </th>
        <td class="fragment fade-in" data-fragment-index="8" style="font-size: smaller; vertical-align: top; text-align: center">Key (0-127)</td>
        <td class="fragment fade-in" data-fragment-index="8" style="font-size: smaller; vertical-align: top; text-align: center">Pressure (0-127)</td>
    </tr>
<tr class="fragment highlight-current-blue" data-fragment-index="9" >
        <th class="fragment fade-in" data-fragment-index="5" style="font-size: smaller">
            Controller Change
        </th>
        <td class="fragment fade-in" data-fragment-index="9" style="font-size: smaller; vertical-align: top; text-align: center">Controller (0-127)</td>
        <td class="fragment fade-in" data-fragment-index="9" style="font-size: smaller; vertical-align: top; text-align: center">Value (0-127)</td>
    </tr>
<tr class="fragment highlight-current-blue" data-fragment-index="10" >
        <th class="fragment fade-in" data-fragment-index="5" style="font-size: smaller">
            Program Change
        </th>
        <td class="fragment fade-in" data-fragment-index="10" style="font-size: smaller; vertical-align: top; text-align: center">Preset Number (0-127)</td>
        <td class="fragment fade-in" data-fragment-index="10" style="font-size: smaller; vertical-align: top; text-align: center"><em>none</em></td>
    </tr>
<tr class="fragment highlight-current-blue" data-fragment-index="11" >
        <th class="fragment fade-in" data-fragment-index="5" style="font-size: smaller">
            Channel Pressure
        </th>
        <td class="fragment fade-in" data-fragment-index="11" style="font-size: smaller; vertical-align: top; text-align: center">Pressure (0-127)</td>
        <td class="fragment fade-in" data-fragment-index="11" style="font-size: smaller; vertical-align: top; text-align: center"><em>none</em></td>
    </tr>
<tr class="fragment highlight-current-blue" data-fragment-index="12" >
        <th class="fragment fade-in" data-fragment-index="5" style="font-size: smaller">
            Pitch Bend
        </th>
        <td class="fragment fade-in" data-fragment-index="12" style="font-size: smaller; vertical-align: top; text-align: center">Fine (0-127)</td>
        <td class="fragment fade-in" data-fragment-index="12" style="font-size: smaller; vertical-align: top; text-align: center">Coarse (0-127)</td>
    </tr>

</table>
<div class="fragment fade-in" data-fragment-index="13" style="font-size: small">For pitch bend: 128 values is not sufficient resolution for detuning a note, so the two data bytes are added together to create a 14-bit value (16,384 possible values)</div>

---V


### A Loud Middle C on MIDI channel 5


<table>
  <thead>
    <tr>
      <th>Status Byte</th>
      <th>Data Byte 1</th>
      <th>Data Byte 2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>10010100</code></td>
      <td><code>00111100</code></td>
      <td><code>01111111</code></td>
    </tr>
  </tbody>
</table>



---H

### Expressing Numbers

We can express numbers in a variety of arbitrary ways.

<table style="font-size: smaller">
  <thead>
    <tr>
      <th>Binary</th>
      <th>Decimal</th>
      <th>Hex</th>
      <th>Binary</th>
      <th>Decimal</th>
      <th>Hex</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>0000</code></td><td><code>0</code></td><td><code>0</code></td>
      <td><code>1000</code></td><td><code>8</code></td><td><code>8</code></td>
    </tr>
    <tr>
      <td><code>0001</code></td><td><code>1</code></td><td><code>1</code></td>
      <td><code>1001</code></td><td><code>9</code></td><td><code>9</code></td>
    </tr>
    <tr>
      <td><code>0010</code></td><td><code>2</code></td><td><code>2</code></td>
      <td><code>1010</code></td><td><code>10</code></td><td><code>A</code></td>
    </tr>
    <tr>
      <td><code>0011</code></td><td><code>3</code></td><td><code>3</code></td>
      <td><code>1011</code></td><td><code>11</code></td><td><code>B</code></td>
    </tr>
    <tr>
      <td><code>0100</code></td><td><code>4</code></td><td><code>4</code></td>
      <td><code>1100</code></td><td><code>12</code></td><td><code>C</code></td>
    </tr>
    <tr>
      <td><code>0101</code></td><td><code>5</code></td><td><code>5</code></td>
      <td><code>1101</code></td><td><code>13</code></td><td><code>D</code></td>
    </tr>
    <tr>
      <td><code>0110</code></td><td><code>6</code></td><td><code>6</code></td>
      <td><code>1110</code></td><td><code>14</code></td><td><code>E</code></td>
    </tr>
    <tr>
      <td><code>0111</code></td><td><code>7</code></td><td><code>7</code></td>
      <td><code>1111</code></td><td><code>15</code></td><td><code>F</code></td>
    </tr>
  </tbody>
</table>

---V

### Expressing Numbers in JavaScript

<table style="font-size: smaller">
  <thead>
    <tr>
      <th>Number System</th>
      <th>Example</th>
      <th>Prefix / Notation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Decimal (base 10)</td>
      <td><code>42</code></td>
      <td>None</td>
    </tr>
    <tr>
      <td>Binary (base 2)</td>
      <td><code>0b101010</code></td>
      <td><code>0b</code></td>
    </tr>
    <tr>
      <td>Hexadecimal (base 16)</td>
      <td><code>0x2A</code></td>
      <td><code>0x</code></td>
    </tr>
  </tbody>
</table>

---V

<h2>Why Hexadecimal?</h2>
  <ul>
    <li class="fragment">One <strong>hex digit</strong> = <code>4 bits</code> (a nibble)</li>
    <li class="fragment">Two hex digits = <code>8 bits</code> (a byte)</li>
    <li class="fragment">Much shorter than binary: <code>0xFF</code> instead of <code>11111111</code></li>
    <li class="fragment">Easy to read and write values for bytes in code</li>
  </ul>
  <p class="fragment">
    Example: <code>0x7F</code> = <code>01111111</code> (decimal <code>127</code>)
  </p>

---V

<h2>Hexadecimal is Readable</h2>
  <ul>
    <li class="fragment">Each nibble can carry different info (e.g., command + channel)</li>
    <li class="fragment">Easier to see than long binary strings</li>
  </ul>

  <table>
    <thead>
      <tr class="fragment">
        <th>Hex</th>
        <th>Binary</th>
        <th>Meaning</th>
      </tr>
    </thead>
    <tbody>
      <tr class="fragment">
        <td><code>9</code></td>
        <td><code>1001</code></td>
        <td>Note On command</td>
      </tr>
      <tr class="fragment">
        <td><code>4</code></td>
        <td><code>0100</code></td>
        <td>Channel 5</td>
      </tr>
      <tr class="fragment">
        <td><code>0x94</code></td>
        <td><code>10010100</code></td>
        <td>"Note On" on channel 5</td>
      </tr>
    </tbody>
  </table>


---V

<iframe
data-src="https://must4707.github.io/06_Week.Lecture.A.Binary.Decimal.Hexadecimal/"
width="100%" height="500" style="border: 2px solid black; border-radius: 6px;">
</iframe>

---V

<iframe
data-src="../embedded-examples/Week6/index.html"
width="100%" height="500px" style="border: 2px solid black; border-radius: 6px;">
width="100%" height="500px" style="border: 2px solid black; border-radius: 6px;">
</iframe>


---H


### What is Pseudocode?

<ul>
  <li class="fragment">Plain-language description of code</li>
  <li class="fragment">Not real syntax: just the idea of the steps</li>
  <li class="fragment">Lets you plan before worrying about details</li>
  <li class="fragment">Easier to read than real code</li>
</ul>

---V

### Example of Pseudocode


**Function PlayScale(startNote):**
- Repeat 4 times:
  - Play current note
  - Wait half a second
  - Move to next note 
- End

_Takes an argument (`startNote`)_

---V

### Pseudocode
 
- Reads like instructions in English  
- Can be turned into a programming language later  


---V

### Group Activity: Pseudocode with MIDI

- Break into small groups
- Each group will take **MIDI input** (key + velocity)
- Write **pseudocode** to solve a task
- Don't worry about syntax: just describe the steps clearly

---V

### Example Tasks

1. Play the note if velocity > 0
2. Transpose the note up by one octave if velocity is greater than 100
3. If velocity < 50, play quietly; otherwise play loudly
4. Convert velocity into a linear amplitude (0.0-1.0)

---V

### Guidelines

- Start with: *When a MIDI note arrives...*
- Use indentation for steps inside
- Think in plain English before turning it into code

---H

### MIDI in the Browser

- Web MIDI lets a webpage read MIDI messages from a keyboard or controller.
- You must give permission in the browser.
- Great for triggering sounds made with the Web Audio API.

---V

### In Code

```js
const setupMIDI = function () {
  navigator.requestMIDIAccess().then((midi) => {
    midi.inputs.forEach((input) => {
      input.onmidimessage = handleMIDIMessage;
    });
  });
};

const handleMIDIMessage = function (rawMIDI) {
    //An Array of three bytes!
  const [status, data1, data2] = rawMIDI.data; // status, note, velocity
  console.log(status, data1, data2);
};
```

---V

```js
_midiParser(event) {
        const data = event.data;             // Uint8Array
        const status = data[0];
        const command = status & 0xF0;       // high nibble
        const channel = status & 0x0F;       // 0-15
        const data1 = data[1];               // may be undefined for some messages
        const data2 = data[2];               // may be undefined for some messages

        switch (command) {
            case 0x80: // Note Off
                this.onNoteOff(data1, data2 ?? 0, channel);
                break;

            case 0x90: // Note On (or Note Off if velocity 0)
                if (data2 && data2 > 0) {
                    this.onNoteOn(data1, data2, channel);
                } else {
                    this.onNoteOff(data1, 0, channel);
                }
                break;

            case 0xA0: // Polyphonic Key Pressure
                this.onPolyKeyPressure(data1, data2 ?? 0, channel);
                break;

            case 0xB0: // Control Change
                this.onControllerChange(data1, data2 ?? 0, channel);
                break;

            case 0xC0: // Program Change (1 data byte)
                this.onProgramChange(data1, channel);
                break;

            case 0xD0: // Channel Pressure (1 data byte)
                this.onChannelPressure(data1, channel);
                break;

            case 0xE0: { // Pitch Bend (14-bit: LSB=data1, MSB=data2)
                const value14 = ((data2 ?? 0) << 7) | (data1 ?? 0); // 0..16383
                const bend = value14 - 8192; // center at 0
                // Pass both signed bend and raw 14-bit value
                this.onPitchBend(bend, channel, value14);
                break;
            }

            default:
                break;
        }
    }

```

---V


### Callback Functions

- A **callback** is a function passed into another function.
- It is "called back" later, usually when something happens.
- Common in browser code: events, timers, MIDI, audio.
- When we create our MIDI class, we will assign custom functions to each type of MIDI event

```js
midi.onNoteOn = (pitch ,v) => { 
    note = new Synth(ctx, ctx.destination, p); 
    note.start(v/127); 
    }

```

---H

### Wrap Up

- MIDI messages: **Status** (`1xxxxxxx`) + **Data** (`0xxxxxxx`) with 7-bit values **0&ndash;127**
- Status byte = **high nibble** message type + **low nibble** channel (0&ndash;15)
- We will use the status byte to route our MIDI data to specific commands (functions)

---V

### A question?

With **_128 possible_** MIDI pitches and **_16 channels_** how many notes could theoretically sound at once? 

$$
7\ \text{bits} + 4\ \text{bits}
$$<!-- .element: class="fragment" -->

$$
2^7 \times 2^4 = 2^{7+4} = 2^{11}
$$<!-- .element: class="fragment" -->


_How might we keep track of that many different notes?_ <!-- .element: class="fragment" -->


